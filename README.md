# APIdog Local LongPoll Proxy

APIdog Local LongPoll Proxy (LLPP) - мини-сервис, реализующий прокси до API и LongPoll ВКонтакте для сайта [apidog.ru](https://apidog.ru/). Может использоваться вместо расширения для браузера APIdog Plus, поскольку покрывает даже больше кейсов, чем расширение.

## Запуск
### Простое использование

В релизах находятся готовые бинари всех версий APIdog LLPP для Windows и Linux - можно просто скачать файл и запустить его.

### Продвинутое использование

Для тех, кто хочет что-то модифицировать или запускать APIdog LLPP из исходников:

1. Клонировать репозиторий:
	```bash
	git clone https://github.com/APIdog/apidog-local-longpoll-proxy.git
	cd apidog-local-longpoll-proxy
	```
1. Запустить сервер:
	```bash
	node index.js
	# или
	npm start
	```

Для компиляции бинарного файла нужно сделать следующие действия:
1. Установить зависимости
	```bash
	npm ci
	```
2. Собрать бинарь
	```bash
	npm run build
	```
3. Запустить
	- двойным кликом по созданному файлу `apidog-longpoll-win.exe` в Windows;
	- двойным кликом по созданному файлу `apidog-longpoll-linux` или командой в терминале `./apidog-longpoll-linux` в Linux.

## Принцип работы
### Связь с APIdog

При открытии веб-клиента APIdog отправляет запрос на адрес http://127.0.0.1:4006/ack (localhost, порт 4006, путь /ack) и ожидает ответа в течение 500мс.
* В случае, если ответ не получен, предпринимается попытка инициализировать расширение APIdog Plus.
* В случае, если ответ получен, в эту сессию клиент отправляет все запросы к API именно через LLPP и стартует сервис LongPoll.

### LongPoll

ВКонтакте поддерживает мгновенное получение сообщений через LongPoll сервер. Использование и формат ответов LongPoll описаны в [документации ВКонтакте](https://dev.vk.com/api/user-long-poll/getting-started).

APIdog без расширения и LLPP не может отправлять напрямую, поскольку это кроссдоменный запрос. LongPoll сервер ВКонтакте не отправляет заголовки по CORS, которые разрешают сайту получить ответ по этому запросу. Также, в отличие от api.vk.com, LongPoll не поддерживает возвращение ответа в формате JSONP (JSON с callback). Расширение и LLPP позволяют обойти ограничение, связанное с отсутствующими заголовками CORS.

### API

Через LLPP также проходят запросы к API ВКонтакте. Это требуется для:
* обхода ограничения на размер запроса в 4КБ (из них полезной нагрузки ещё меньше; это ограничение GET-запроса). При отсутствии LLPP такие запросы отправляются POST-ом через apidog.ru:4007 (прокси со стороны APIdog).
* добавления заголовка User-Agent с значением официального приложения ВКонтакте. С таким заголовком ВКонтакте даёт чуть больше данных для лучшего функционирования сайта.
